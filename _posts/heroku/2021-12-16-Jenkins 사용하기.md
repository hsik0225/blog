---
layout: post
title: "[Heroku] Jenkins 사용하기"
categories: [Heroku]
---

Heroku에서 CI&CD 도구인 Jenkins를 사용합니다.

> Heroku에서 제공하는 무료 다이노(어플리케이션이 배포되는 컨테이너)의 램 용량은 512MB로, Jenkins를 사용하기에는 매우 부족합니다. 
> 
> Jenkins 메인 페이지에 가만히 있어도 메모리가 100%를 초과했다는 로그를 볼 수 있습니다.
> 
> 그러므로 `Free & Hobby` 정책을 사용하고 계신 분들은 사용하지 않는 것이 좋아보입니다.
>

# Create new app

1. 헤로쿠가 설치되어 있지 않다면 먼저 Heroku CLI를 설치합니다.

```bash
$ brew tap heroku/brew && brew install heroku
```

1. Jenkins를 설치할 Heroku App을 생성합니다.

```bash
# heroku apps:create <jenkins_app_name>
$ heroku apps:create seed-jenkins
```

1. WAR file을 헤로쿠에 배포해주는 `Heroku Java CLI Plugin`을 설치합니다.

   `Heroku Java CLI Plugin`은 Tomcat Webapp Runner로 어플리케이션을 실행합니다.

   ```bash
   $ heroku plugins:install java
   ```

2. jenkins war 파일을 다운로드합니다.

   [https://www.jenkins.io/download/](https://www.jenkins.io/download/) 링크에서 jenkins.war 파일을 다운로드할 수 있습니다.

3. heroku에 jenkins를 배포합니다.

   자바가 로컬에 설치되어 있다면, 다음 명령어로 배포할 수 있습니다.

   Jenkins가 Java8보다는 Java11을 권장하기에 `jdk 11` 옵션을 추가합니다.

   ```bash
   # heroku war:deploy <path_to_war_file> --app <app_name>
   $ heroku war:deploy jenkins.war --app seed-jenkins --jdk 11
   ```

# Jenkins Getting Started
1. `https://<jenkins_app_name>.herokuapp.com` 으로 접속합니다.
2. Administrator password를 입력합니다.
   ![image](https://user-images.githubusercontent.com/56301069/145724991-4b2c0e3a-0660-4a75-9be5-7c556a48e7bc.png)

   터미널에서 다음 명령어를 입력합니다.

   ```bash
   $ heroku logs --tail <jenkins_app_name>
   ```

   길게 나오는 로그에서
   
   ```bash
   Please use the following password to proceed to installation:
   
   <password>
   
   This may also be found at: /app/.jenkins/secrets/initialAdminPassword
   ```
   
   `<password>`를 찾고, 해당 password를 입력합니다.
   
   > 만약 로그에서 패스워드를 발견하지 못했다면, 헤로쿠에서 앱을 지우고 다시 설치해봅니다.
   >

3. `Install suggested plugins`를 클릭합니다.
   ![image](https://user-images.githubusercontent.com/56301069/145724996-4b16d5db-018d-4915-825b-5895bb26fc03.png)


4. Admin 설정을 합니다.
   ![image](https://user-images.githubusercontent.com/56301069/145724993-db0191a8-6263-41e8-8058-74d5b8bd8532.png)

# Caution
헤로쿠는 다이노(Jenkins를 설치한 헤로쿠 앱)를 재시작하면 안에 설치된 모든 파일을 삭제하고 초기 상태로 돌아갑니다. 즉 재시작을 하면, 처음 비밀번호 설정부터 다시 시작해야 합니다. 그러므로 Jenkins를 설치한 이후 절대 재시작이 되지 않도록 해야합니다.

다이노 매니저는 다음 상황에서 다이노를 재실행하니 주의바랍니다.

- 새로운 커밋을 헤로쿠 저장소에 푸시했을 때
- `config vars`를 수정했을 때
- `add-ons`를 추가하거나 삭제했을 때
- `heroku restart`를 실행했을 때
